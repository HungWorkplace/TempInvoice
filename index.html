<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Temp Invoice Print</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        padding: 16px;
      }
      .muted {
        color: #666;
      }
      .error {
        color: #b00020;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <div id="status">Đang tải hóa đơn…</div>
    <div id="details" class="muted"></div>
    <div id="error" class="error" hidden></div>

    <noscript> Trang này cần JavaScript để in hóa đơn. </noscript>

    <script>
      (() => {
        "use strict";

        const CONFIG = {
          redirectUrl: "https://cuahangthuyvui.kiotviet.vn/sale/#/",
          apiBaseUrl:
            "https://localstorage-kv-sync.hung-workplace.workers.dev/temp-bill",
          vatRate: 0.015,
        };

        const STORE = {
          name: "TRUNG TÂM MUA SẮM THỦY VUI",
          subtitle: "SỬA XE ĐẠP - XE MÁY - THUỐC TÂN DƯỢC",
          address: "ĐC: Thủy Vui, Sào Lâm, Văn Phú",
        };

        const PRINT_CSS = `
          html, body { margin: 0; padding: 0; }
          body { font-family: Arial, Helvetica, sans-serif; }
          .receipt { font-size: 11px; line-height: 1.25; padding: 8px; }
          .center { text-align: center; }
          .brand { font-weight: 700; font-size: 10px; }
          .subtitle { font-weight: 700; font-size: 10px; margin-top: 2px; }
          .stars { font-weight: 700; font-size: 10px; margin-top: 6px; }
          .title { font-weight: 700; font-size: 12px; margin-top: 8px; }
          .time { font-size: 11px; margin-top: 6px; }
          .row { margin-top: 6px; }

          .items { width: 100%; border-collapse: collapse; margin-top: 8px; }
          .items td { padding: 3px 0; vertical-align: top; }
          .items thead td { border-top: 1px solid #000; border-bottom: 1px solid #000; font-weight: 700; padding: 4px 0; }
          .items tbody td { border-bottom: 1px dashed #000; padding: 4px 0; }
          .items .name { width: 60%; }
          .items .price { width: 15%; }
          .right { text-align: right; }

          .total { margin-top: 10px; font-family: "Times New Roman", Times, serif; }
          .total .label { font-size: 12px; }
          .total .value { font-size: 18px; font-weight: 700; }
          .note { font-family: "Times New Roman", Times, serif; font-size: 8px; margin-top: 2px; }

          .details { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 11px; }
          .details td { padding: 4px 0; vertical-align: middle; }
          .dots { white-space: nowrap; text-align: right; color: #888; }

          .footer { margin-top: 12px; font-size: 12px; }
          .address { margin-top: 8px; font-size: 11px; font-weight: 700; }
          .slogan { margin-top: 10px; padding-top: 10px; border-top: 1px dotted #000; text-align: center; font-size: 12px; font-weight: 700; }
        `;

        const ui = {
          status: document.getElementById("status"),
          details: document.getElementById("details"),
          error: document.getElementById("error"),
        };

        function setStatus(text, detail) {
          ui.status.textContent = String(text ?? "");
          ui.details.textContent = detail ? String(detail) : "";
        }

        function showError(message) {
          ui.error.hidden = false;
          ui.error.textContent = String(message ?? "");
        }

        function safeNumber(value, fallback = 0) {
          const numeric = typeof value === "number" ? value : Number(value);
          return Number.isFinite(numeric) ? numeric : fallback;
        }

        function formatMoney(amount) {
          const numeric = safeNumber(amount, NaN);
          if (!Number.isFinite(numeric)) return "";
          return new Intl.NumberFormat("vi-VN").format(numeric);
        }

        function formatDateTime(value) {
          const date = value ? new Date(value) : new Date();
          if (Number.isNaN(date.getTime())) return "";
          return date.toLocaleString("vi-VN");
        }

        function splitNameAndUnit(rawName) {
          const name = String(rawName ?? "").trim();
          if (!name) return { name: "", unit: "" };

          // pattern: "Tên hàng - (đơn vị)" or "Tên hàng (đơn vị)"
          const match = name.match(/^(.*?)(?:\s*-\s*)?\(([^)]+)\)\s*$/);
          if (!match) return { name, unit: "" };

          const baseName = String(match[1] ?? "").trim();
          const unit = String(match[2] ?? "").trim();
          return { name: baseName || name, unit };
        }

        function getDeviceParam() {
          const url = new URL(window.location.href);
          const device = String(url.searchParams.get("device") ?? "").trim();
          return device;
        }

        async function fetchBill(device) {
          const apiUrl = new URL(CONFIG.apiBaseUrl);
          apiUrl.searchParams.set("device", device);

          const res = await fetch(apiUrl.toString(), { cache: "no-store" });
          if (!res.ok) {
            throw new Error(`API lỗi: ${res.status} ${res.statusText}`);
          }

          const json = await res.json();
          if (!json || !json.data) {
            throw new Error("API không có trường data");
          }

          return json.data;
        }

        function el(doc, tag, className, text) {
          const node = doc.createElement(tag);
          if (className) node.className = className;
          if (text !== undefined && text !== null)
            node.textContent = String(text);
          return node;
        }

        function appendText(doc, parent, text) {
          parent.appendChild(doc.createTextNode(String(text ?? "")));
        }

        function renderReceipt(doc, bill) {
          const items = Array.isArray(bill?.items) ? bill.items : [];
          const total = safeNumber(bill?.total, 0);
          const vat = Math.round(total * CONFIG.vatRate);

          // Optional fields (not present in current API, but supported if later added)
          const customerName = String(bill?.customerName ?? "").trim();
          const storePhone = String(bill?.storePhone ?? "").trim();
          const orderCode = String(bill?.orderCode ?? "").trim();
          const priceListName = String(bill?.priceListName ?? "").trim();

          const root = el(doc, "div", "receipt");
          root.id = "kv-cke-temp";

          const header = el(doc, "div", "center");
          header.appendChild(el(doc, "div", "brand", STORE.name));
          header.appendChild(el(doc, "div", "subtitle", STORE.subtitle));
          header.appendChild(el(doc, "div", "stars", "************"));
          header.appendChild(el(doc, "div", "title", "HÓA ĐƠN THANH TOÁN"));
          header.appendChild(
            el(doc, "div", "time", `GIỜ: ${formatDateTime(bill?.savedAt)}`)
          );
          root.appendChild(header);

          // Seller / phone
          const sellerRow = el(doc, "div", "row");
          appendText(
            doc,
            sellerRow,
            "Người bán: ................................. SĐT: "
          );
          if (storePhone) {
            sellerRow.appendChild(el(doc, "span", null, storePhone));
          }
          root.appendChild(sellerRow);

          // Customer
          const customerRow = el(doc, "div", "row");
          appendText(doc, customerRow, "Khách Hàng: ");
          customerRow.appendChild(el(doc, "strong", null, customerName));
          root.appendChild(customerRow);

          // Items table
          const table = el(doc, "table", "items");
          table.id = "itemTable";

          const thead = doc.createElement("thead");
          const headTr = doc.createElement("tr");
          headTr.appendChild(el(doc, "td", "name", "Sản Phẩm"));
          headTr.appendChild(el(doc, "td", "right price", "Giá"));
          headTr.appendChild(el(doc, "td", "right", "Thành Tiền"));
          thead.appendChild(headTr);
          table.appendChild(thead);

          const tbody = doc.createElement("tbody");
          for (const item of items) {
            const qty = safeNumber(item?.qty, 0);
            const amount = safeNumber(item?.amount, 0);
            const unitPrice = qty > 0 ? Math.round(amount / qty) : amount;
            const { name, unit } = splitNameAndUnit(item?.name);

            const tr = doc.createElement("tr");

            const nameTd = el(doc, "td", "name");
            const nameStrong = el(doc, "strong");
            nameStrong.textContent = `${qty || ""} ${unit || ""} ${
              name || ""
            }`.trim();
            nameTd.appendChild(nameStrong);
            tr.appendChild(nameTd);

            tr.appendChild(
              el(doc, "td", "right price", formatMoney(unitPrice))
            );

            const amountTd = el(doc, "td", "right");
            amountTd.appendChild(el(doc, "strong", null, formatMoney(amount)));
            tr.appendChild(amountTd);

            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          root.appendChild(table);

          // Total
          const totalWrap = el(doc, "div", "total");
          totalWrap.appendChild(el(doc, "span", "label", "Tổng:"));
          totalWrap.appendChild(
            el(doc, "strong", "tong-tien-hang value", formatMoney(total))
          );
          root.appendChild(totalWrap);
          root.appendChild(el(doc, "div", "note", "(Đã bao gồm thuế)"));

          const spacer = doc.createElement("div");
          spacer.id = "hungw-test";
          spacer.innerHTML = "&nbsp;";
          root.appendChild(spacer);

          // Details
          const detailsTable = el(doc, "table", "details");
          const detailsBody = doc.createElement("tbody");

          // Row 1: orderCode - priceListName (only if any present)
          if (orderCode || priceListName) {
            const tr1 = doc.createElement("tr");
            const td1 = doc.createElement("td");
            appendText(doc, td1, orderCode);
            appendText(doc, td1, " - ");
            td1.appendChild(el(doc, "strong", null, priceListName));
            tr1.appendChild(td1);
            tr1.appendChild(el(doc, "td", "dots", "........................."));
            detailsBody.appendChild(tr1);
          }

          // Row 2: total item lines
          const tr2 = doc.createElement("tr");
          const td2 = doc.createElement("td");
          appendText(doc, td2, "Tổng Số Lượng: ");
          td2.appendChild(el(doc, "strong", null, `${items.length} thứ`));
          tr2.appendChild(td2);
          tr2.appendChild(el(doc, "td", "dots", "........................."));
          detailsBody.appendChild(tr2);

          // Row 3: VAT
          const tr3 = doc.createElement("tr");
          const td3 = doc.createElement("td");
          appendText(doc, td3, "Thuế VAT 1.5% nộp về nhà nước: ");
          td3.appendChild(el(doc, "span", null, formatMoney(vat)));
          tr3.appendChild(td3);
          detailsBody.appendChild(tr3);

          detailsTable.appendChild(detailsBody);
          root.appendChild(detailsTable);

          // Footer text (kept similar to the reference template)
          const footer = el(doc, "div", "footer");
          appendText(doc, footer, "Mới: ");
          footer.appendChild(
            el(doc, "strong", null, "RÚT TIỀN ATM, CHUYỂN TIỀN,")
          );
          appendText(doc, footer, " THANH TOÁN ");
          footer.appendChild(el(doc, "strong", null, "ĐIỆN NƯỚC"));
          appendText(doc, footer, " tại ");
          footer.appendChild(el(doc, "strong", null, "Cửa Hàng"));
          root.appendChild(footer);

          root.appendChild(el(doc, "div", "address", STORE.address));

          const slogan = el(doc, "div", "slogan");
          slogan.appendChild(
            el(doc, "strong", null, "Gì cũng có - mua hết ở Thủy Vui")
          );
          root.appendChild(slogan);

          return root;
        }

        function printWithSystemDialog(bill) {
          // Use an off-screen iframe to trigger Chrome Print Preview / system print dialog.
          // This avoids opening a popup window (and avoids popup blockers).
          return new Promise((resolve, reject) => {
            const iframe = document.createElement("iframe");
            iframe.setAttribute("title", "print");
            iframe.style.position = "fixed";
            iframe.style.right = "0";
            iframe.style.bottom = "0";
            iframe.style.width = "0";
            iframe.style.height = "0";
            iframe.style.border = "0";
            iframe.style.opacity = "0";
            iframe.style.pointerEvents = "none";
            iframe.src = "about:blank";

            let settled = false;
            const cleanup = () => {
              try {
                iframe.remove();
              } catch (_) {}
            };
            const done = () => {
              if (settled) return;
              settled = true;
              window.removeEventListener("focus", onFocus);
              cleanup();
              resolve();
            };
            const fail = (err) => {
              if (settled) return;
              settled = true;
              window.removeEventListener("focus", onFocus);
              cleanup();
              reject(err);
            };

            // Fallback: when the print dialog closes, the page usually regains focus.
            // We attach focus listener slightly after calling print to reduce false positives.
            let focusArmed = false;
            const onFocus = () => {
              if (!focusArmed) return;
              setTimeout(done, 0);
            };

            const setupAndPrint = () => {
              try {
                const doc = iframe.contentDocument;
                const win = iframe.contentWindow;
                if (!doc || !win) throw new Error("Không thể tạo ngữ cảnh in");

                doc.open();
                doc.write(`<!doctype html><html lang="vi"><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Print</title>
  <style>${PRINT_CSS}</style>
</head><body></body></html>`);
                doc.close();

                doc.body.appendChild(renderReceipt(doc, bill));

                // Preferred signal
                win.onafterprint = () => {
                  done();
                };

                window.addEventListener("focus", onFocus);
                // Arm focus after print has had a moment to open.
                setTimeout(() => {
                  focusArmed = true;
                }, 500);

                setTimeout(() => {
                  try {
                    win.focus();
                  } catch (_) {}
                  win.print();
                }, 50);
              } catch (err) {
                fail(err);
              }
            };

            iframe.onload = setupAndPrint;
            document.body.appendChild(iframe);

            // In some browsers, onload may not fire for about:blank; attempt immediately too.
            setTimeout(() => {
              if (settled) return;
              if (iframe.contentDocument && iframe.contentWindow) {
                setupAndPrint();
              }
            }, 0);
          });
        }

        async function run() {
          const device = getDeviceParam();
          if (!device) {
            setStatus("Thiếu tham số device.");
            ui.details.textContent = "Ví dụ: ?device=1 (device là số 1,2,3…)";
            return;
          }
          if (!/^\d+$/.test(device)) {
            setStatus("device không hợp lệ.");
            ui.details.textContent = "device phải là số (vd: ?device=1)";
            return;
          }

          setStatus("Đang lấy dữ liệu…", `device=${device}`);
          const bill = await fetchBill(device);

          setStatus("Đang mở hộp thoại in…");
          await printWithSystemDialog(bill);

          setStatus("Đang quay lại KiotViet…");

          window.location.href = CONFIG.redirectUrl;
        }

        run().catch((err) => {
          setStatus("Không thể in hóa đơn.");
          showError(String(err?.message || err));
        });
      })();
    </script>
  </body>
</html>
